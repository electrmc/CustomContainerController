#交互式转场
从感觉上说，交互式转场要比非交互式转场复杂非常多，但也正是因为人机交互才让app更有意思。</br>
交互式转场的核心有两个：1，交互式动画如何实现；2，通过转场上下文配合转场协议完成转场流程的控制。交互式动画是比较麻烦的，这里不详细介绍。主要是应用CAMediaTiming协议来控制动画的前进后退以及取消，其中关键是begintime，timeoffset和speed的关系。但是交互式动画的水还是比较深的，在这过程中有可能会出现令人难解的问题比如闪屏之类的，在应用时要注意。下面主要是介绍转场流程的控制。</br>
##转场流程控制
###1，如何控制
转场流程控制其实还是通过控制动画的流程。既然动画是可控的，肯定是有一个控制器。这个控制器就是实现了UIViewControllerInteractiveTransitioning协议的对象，暂且称为交互式控制器。该对象的主要功能是控制转场动画的开始、更新、结束、取消。它一般是由手势驱动，即手势产生的事件直接调用该对象的方法。然后再由交互式控制器通知转场上下文，由转场上下文来控制动画进程。虽然交互式控制器在生成时可以取到动画本身，但是它并没有直接操作动画。因为动画添加到layer后是不可改变的，不能被操作；其次交互式动画一般是操作Animation的superLayer的time来完成动画控制的。因此，在该demo中交互式控制器并没有持有动画本身，而是通过UIViewControllerContextTransitioning（即实现该协议的转场上下文对象）来完成操作。
###2，控制过程
控制过程分为四步：转场开始，更新转场动画，转场完成或取消转场。转场动画就是一帧帧的画面，动画控制也就是控制每一帧画面渲染的内容。其中最麻烦的是动画的更新和动画取消。而比较容易出bug的是动画取消。
####1，转场开始
转场开始前，首先要判断转场动画支不支持交互。想要支持交互式动画就必须有交互式控制器。非交互式中转场中的动画是由第三方提供的，那交互控制器也肯定由第三方提供。此处的第三方一般是一个实现自定义的协议的对象，比如该demo中的ContainerTransitionDelegate协议，该协议类似于系统转场中的UIViewControllerTransitioningDelegate。其功能就是提供转场动画和交互式控制器。当实现了该协议的对象能够提供交互式控制器时，就表明转场过程支持交互。不过支持并不表示转场一定是交互的，比如交互式和非交互式转场都用同一个对象来提供动画控制器和交互式控制器，那么就需要containerViewController来判断转场过程是否是可交互式的。比如点击按钮进行的转场不可交互，手势引发的转场是可交互的。
####2，转场动画更新
动画更新的就是控制转场动画的进度，其本质就是要能根据手势的进度来控制每一帧画面渲染的内容。当然这里又涉及到了CAMediaTiming协议，不细说。当手势更新时，会调用交互式控制器的更新动画的方法（自定义方法）。该方法接受的参数一般是手势的进度。然后由该方法调用转场上下文中的updateInteractiveTransition()方法（属于UIViewControllerContextTransitioning协议）。由转场上下文来根据进度控制containerView.layer的time最终完成动画的前进或后退。
####3，转场动画完成
当手势完成后，表明转场完成，此时会调用交互式控制器的完成方法，再由该方法调用转场上下文中的finishInteractiveTransition()方法
（属于UIViewControllerContextTransitioning协议）。在该方法中，即转场上下文中处理交互式完成后所做的事情，这里需要干两件事：</br>
1，设置animation的superlayer的时间到动画结束时间，以让动画控制器调用动画完成的操作（一般是finish block）。在该finish block中才调用转场上下文的completeTransition()方法。在completeTransition()方法中再完成视图控制器的添加和移除。</br>
2，通知容器控制器的进度完成，一般说来，交互式转场中，容器控制器上的其他元素也会根据动画进度来改变。</br>
这里需要注意的是，交互式动画完成与转过程完成是不一样的。交互式完成调用的是UIViewControllerContextTransitioning协议中的finishInteractiveTransition()方法，它是由交互式控制器来调用的。而整个转场过程完成调用的是UIViewControllerContextTransitioning协议中的completeTransition()方法，而该方法是动画控制器完成后调用的。其调用过程在上面说了。
####4，取消转场
转场取消和转场完成类似。手势取消后调用交互式控制器的取消转场方法，然后由该方法再调用UIViewControllerContextTransitioning协议中的cancelInteractiveTransition()。不同于finishInteractiveTransition()方法做的事，它是要把先前未完成的转场动画逆着播放一遍直到动画的初始状态。整个过程也做两件事：</br>
1，每隔1/60s更新一次animation.superlayer的时间来控制逆转动画中每一帧渲染的内容，直到superlayer的时间回到动画添加的时刻。
此时动画就已经逆转完成，然后由动画控制来调用UIViewControllerContextTransitioning协议中的completeTransition()方法。当然，此时的completeTransition()方法收到的参数肯定是false。</br>
2，在逆转过程中通知容器控制器来逆转转场中的内容，比如把转场中切换到一半的tabbar(自定义)的标题再恢复原状。</br>
转场取消这个过程的实现一般是由CADisplayLink来完成的。
####5，转场完成
需要注意的动画完成或者说是动画结束与转场完成是不一样的。动画结束是由交互式控制器来控制的。有两种情况认为是动画结束：1，手势完成，动画做完结束；2，手势取消，动画取消。这两种情况调用的交互式控制器和转场上下文的方法都是不一样的，但是最后都会调用动画结束的block。而转场结束只有在动画结束后才会调用。</br>
转场结束后需要判断转场动画是否完成，以此来进行后续的操作：1，完成视图控制器的添加和删除；2，如动画完成，更新containerViewController中的数据到完成的状态。3，如动画未完成，恢复containerViewController到转场开始时的状态。

